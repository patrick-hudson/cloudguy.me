<!DOCTYPE HTML>
<!--
	Strata by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
  <head>
    <title>Automated Amazon EBS Snapshots - Ubuntu 14.04 LTS - I'm in a Cloud!</title>
<meta charset="utf-8" />
<meta name="description" content="Wouldn't it be cool if we could schedule EBS Snapshots with features like backup purging based on how old they are, or possibly target specific instances that are tagged" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
<link rel="stylesheet" href="/assets/css/main.css" />
<!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]-->
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Sitewide ATOM Feed" />
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Sitewide RSS Feed" />
<link rel="author" type="text/plain" href="/humans.txt" />

    <!-- Open Graph -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Automated Amazon EBS Snapshots - Ubuntu 14.04 LTS" />
<meta property="og:description" content="Wouldn't it be cool if we could schedule EBS Snapshots with features like backup purging based on how old they are, or possibly target specific instances that are tagged" />
<meta property="og:site_name" content="I'm in a Cloud!" />
<meta property="og:url" content="/linux/python/automated-amazon-ebs-snapshots/" />


    

  </head>
	<body id="top">

		<!-- Header -->
  <header id="header">
    <a href="/" class="image avatar"><img src="https://avatars0.githubusercontent.com/u/5728403?v=3&s=460" alt="" /></a>
    <h1><strong>I am Patrick</strong>, I’m a guy who always manages to find himself neck deep in the Cloud, and someone who likes to break it.  I also tend to get drunk sometimes.
</h1>
  </header>


		<!-- Main -->
		<div id="main">
      <article>
        <header class="major">
          <h2>Automated Amazon EBS Snapshots - Ubuntu 14.04 LTS</h2>
          <p>
            <span class="hint--bottom" aria-label="Posted On">
              <i class="fa fa-calendar"></i> 
            </span>
              20 August 2015
             on
            <span class="hint--bottom" aria-label="Categories">
              <i class="fa fa-tags"></i> 
            </span>
              AWS, EBS, Ubuntu, Cloud, Linux, and Python.
            
            <span class="hint--bottom" aria-label="Estimated time to complete">
              <i class="fa fa-clock-o"></i> 
            </span>
            20 minutes
            <span class="hint--bottom" aria-label="Difficulty">
              <i class="fa fa-info-circle" aria-hidden="true"></i>
            </span> 
            Intermediate
          </p>
        </header>

        <section>
          <p>Wouldn’t it be cool if we could schedule EBS Snapshots with features like backup purging based on how old they are, or possibly target specific instances that are tagged?</p>

<p>I ran across a great repository that’s aptly named “<a href="https://github.com/colinbjohnson/aws-missing-tools">aws-missing-tools</a>” that’s been created by <a href="https://github.com/colinbjohnson">Colin Johnson</a>.</p>

<p>It contains an insane amount of awesome stuff, but this post will detail one specific tool named <a href="https://github.com/colinbjohnson/aws-missing-tools/tree/master/ec2-automate-backup">ec2-automate-backup</a>. We’re specifically going to use the the ec2-automate-backup-awscli.sh script and not the ec2-automate-backup.sh. The script we’re using utilizes the awscli python package where as the other script utilizes EC2 API Tools. ec2-automate-backup was created to provide easy backup/snapshot functionality for multiple EC2 EBS volumes</p>

<p><em>One thing to note, the server you run that script from does not have to be within the Amazon umbrella. It’ll work anywhere.</em></p>

<div align="center">
  <h1 id="installation">Installation</h1>
</div>

<h4 id="we-need-two-packages-before-getting-started-python-2x-or-3x-and-setup-tools">We need two packages before getting started, Python 2.x or 3.x and Setup Tools</h4>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">sudo apt-get update
apt-get install python python-setuptools</code></pre></figure>

<h4 id="use-easyinstall-to-install-pip">Use easy_install to install pip</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">easy_install pip</code></pre></figure>

<h3 id="finally-use-pip-to-install-awscli">Finally use pip to install awscli</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pip install awscli</code></pre></figure>

<div align="center">
  <h1 id="configuration">Configuration</h1>
</div>

<h3 id="run-the-awscli-configuration-tool-and-fill-in-your-access-key-id-your-secret-access-key-default-region-us-east-1-us-west-1-us-west-2-etc-and-finally-output-format">Run the awscli configuration tool and fill in, your Access Key ID, your Secret Access Key, Default Region (us-east-1, us-west-1, us-west-2, etc) and finally output format</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">aws configure
  AWS Access Key ID <span class="o">[</span>None]: 1234564789987654321
  AWS Secret Access Key <span class="o">[</span>None]: abcdefghijklmnop
  Default region name <span class="o">[</span>None]: us-west-2
  Default output format <span class="o">[</span>None]: json</code></pre></figure>

<h3 id="create-a-new-user-named-backup-agent-and-create-the-home-directory">Create a new user named backup-agent, and create the home directory</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">useradd -m -d /home/backup-agent -s /bin/bash backup-agent</code></pre></figure>

<h3 id="download-the-ec2-automate-backup-awsclishhttpsgithubcomcolinbjohnsonaws-missing-toolsblobmasterec2-automate-backupec2-automate-backup-awsclish-script">Download the <a href="https://github.com/colinbjohnson/aws-missing-tools/blob/master/ec2-automate-backup/ec2-automate-backup-awscli.sh">ec2-automate-backup-awscli.sh</a> script</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl -O https://raw.githubusercontent.com/colinbjohnson/aws-missing-tools/master/ec2-automate-backup/ec2-automate-backup-awscli.sh</code></pre></figure>

<div align="center">
  <h1 id="directions-for-use">Directions For Use</h1>
</div>

<h3 id="example-of-use">Example of Use</h3>

<p><code class="highlighter-rouge">ec2-automate-backup-awscli.sh -v vol-6d6a0527</code></p>

<p>the above example would provide a single backup of the EBS volumeid vol-6d6a0527. The snapshot would be created with the description “vol-6d6a0527_2012-09-07”.</p>

<h4 id="required-parameters">Required Parameters</h4>

<p>ec2-automate-backup-awscli.sh requires one of the following two parameters be provided:</p>

<p><code class="highlighter-rouge">-v &lt;volumeid&gt;</code> - the “volumeid” parameter is required to select EBS volumes for snapshot if ec2-automate-backup-awscli.sh is run using the “volumeid” selection method - the “volumeid” selection method is the default selection method.</p>

<p><code class="highlighter-rouge">-t &lt;tag&gt;</code> - the “tag” parameter is required if the “method” of selecting EBS volumes for snapshot is by tag (-s tag). The format for tag is key=value (example: Backup=true) and the correct method for running ec2-automate-backup-awscli.sh in this manner is ec2-automate-backup-awscli.sh -s tag -t Backup=true.
#### Optional Parameters
<code class="highlighter-rouge">-r &lt;region&gt;</code> - the region that contains the EBS volumes for which you wish to have a snapshot created.</p>

<p><code class="highlighter-rouge">-s &lt;selection_method&gt;</code> - the selection method by which EBS volumes will be selected. Currently supported selection methods are “volumeid” and “tag.” The selection method “volumeid” identifies EBS volumes for which a snapshot should be taken by volume id whereas the selection method “tag” identifies EBS volumes for which a snapshot should be taken by a key=value format tag.</p>

<p><code class="highlighter-rouge">-c &lt;cron_primer_file&gt;</code> - running with the -c option and a providing a file will cause ec2-automate-backup-awscli.sh-awscli.sh to source a file for environmental configuration - ideal for running ec2-automate-backup-awscli.sh-awscli.sh under cron. An example cron primer file is located in the “Resources” directory and is called cron-primer.sh.</p>

<p><code class="highlighter-rouge">-n</code> - tag snapshots “Name” tag as well as description</p>

<p><code class="highlighter-rouge">-h</code> - tag snapshots “InitiatingHost” tag to specify which host ran the script</p>

<p><code class="highlighter-rouge">-k &lt;purge_after_days&gt;</code> - the period after which a snapshot can be purged. For example, running “ec2-automate-backup-awscli.sh-awscli.sh -v “vol-6d6a0527 vol-636a0112” -k 31” would allow snapshots to be removed after 31 days. purge_after_days creates two tags for each volume that was backed up - a PurgeAllow tag which is set to PurgeAllow=true and a PurgeAfter tag which is set to the present day (in UTC) + the value provided by -k.</p>

<p><code class="highlighter-rouge">-p</code> - the -p flag will purge (meaning delete) all snapshots that were created more than “purge after days” ago. ec2-automate-backup-awscli.sh looks at two tags to determine which snapshots should be deleted - the PurgeAllow and PurgeAfter tags. The tags must be set as follows: PurgeAllow=true and PurgeAfter=YYYY-MM-DD where YYYY-MM-DD must be before the present date.</p>
<div align="center">
  <h1 id="potential-uses-and-methods-of-use">Potential Uses and Methods of Use</h1>
</div>

<p>To backup multiple EBS volumes use ec2-automate-backup-awscli.sh as follows:</p>

<p><code class="highlighter-rouge">ec2-automate-backup-awscli.sh -v "vol-6d6a0527 vol-636a0112"</code></p>

<p>To backup a selected group of EBS volumes on a daily schedule tag each volume you wish to backup with the tag “Backup=true” and run ec2-automate-backup-awscli.sh using cron as follows:</p>

<p><code class="highlighter-rouge">0 0 * * * ec2-automate-backup-awscli.sh -s tag -t "Backup=true"</code></p>

<p>To backup a selected group of EBS volumes on a daily and/or monthly schedule tag each volume you wish to backup with the tag “Backup-Daily=true” and/or “Backup-Monthly=true” and run ec2-automate-backup-awscli.sh using cron as follows:</p>

<p><code class="highlighter-rouge">0 0 * * * backup-agent /home/backup-agent/ec2-automate-backup-awscli.sh -s tag -t "Backup-Daily=true"</code></p>

<p><code class="highlighter-rouge">0 0 1 * * backup-agent /home/backup-agent/ec2-automate-backup-awscli.sh -s tag -t "Backup-Monthly=true"</code></p>

<p>To perform daily backup using cron and to load environment configuration with a “cron-primer” file:</p>

<p><code class="highlighter-rouge">0 0 * * * backup-agent /home/backup-agent/ec2-automate-backup-awscli.sh -c /home/backup-agent/cron-primer.sh -s tag -t "Backup=True"</code></p>

<p><code class="highlighter-rouge">-u</code> - the -u flag will tag snapshots with additional data so that snapshots can be more easily located. Currently the two user tags created are Volume=”ebs_volume” and Created=”date.” These can be easily modified in code.</p>

        </section>
      </article>

      


      
      <hr />
      <div class="row">
        <article class="6u 12u$(xsmall) work-item">
          
  			</article>
  			<article class="6u$ 12u$(xsmall) work-item">
          
          <p>Next</p>
  				<h3><a href="/linux/git/gogs-a-self-hosted-github-alternative-on-a-diet/">Gogs: A self hosted GitHub alternative on a diet</a></h3>
  				<p>What's better than hosting your own private GUI for Git so we can keep all of our potentially world ending code from the NSA? Alright, I'll move the tin foil hat to the side for another day. However, when that front end is only consuming 88mb of RAM and the closest competition (cough, cough, GitLab) eats an entire gigabyte before it even finishes starting you know we may have a winner.</p>
          
  			</article>
      </div>
      

		</div>

    <!-- Footer -->
  <footer id="footer">
    <ul class="icons">
      
      
      
      <li><a href="https://linkedin.com/in/hudsonpatrick" class="icon fa-linkedin"><span class="label">Linkedin</span></a></li>
      
      
      
      
      
      <li><a href="https://github.com/patrick-hudson" class="icon fa-github"><span class="label">Github</span></a></li>
      
      
      <li><a href="mailto:phudson2@gmail.com" class="icon fa-envelope-o"><span class="label">Email</span></a></li>
      
      
      <li><a href="/rss.xml" class="icon fa-rss"><span class="label">Feed</span></a></li>
      
    </ul>
    <ul class="copyright">
      <li>&copy; Patrick Hudson</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
    </ul>
    <ul class="copyright">
      Please note: Posts made by myself do not reflect the opinions of any of my employers past or present.
    </ul>
  </footer>

    <!-- Scripts -->
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/jquery.poptrox.min.js"></script>
  <script src="/assets/js/skel.min.js"></script>
  <script src="/assets/js/util.js"></script>
  <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
  <script src="/assets/js/main.js"></script>


	</body>
</html>
